<!DOCTYPE html>
<html>
<head>
    <title>CLIP Image Similarity - Tops & Bottoms</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Upload Clothing Images</h1>
    
    <!-- Tops Upload Section -->
    <div class="upload-section">
        <h2>Upload Tops</h2>
        <input type="file" id="topsInput" accept="image/*" multiple>
        <div id="topsPreview" class="preview-container"></div>
        <button id="uploadTopsBtn" style="display: none;">Upload Tops</button>
    </div>
    
    <!-- Bottoms Upload Section -->
    <div class="upload-section">
        <h2>Upload Bottoms</h2>
        <input type="file" id="bottomsInput" accept="image/*" multiple>
        <div id="bottomsPreview" class="preview-container"></div>
        <button id="uploadBottomsBtn" style="display: none;">Upload Bottoms</button>
    </div>

    <!-- Outfits Upload Section -->
    <div class="upload-section">
        <h2>Upload Complete Outfits</h2>
        <p style="font-size: 0.9em; color: #666; margin-top: -10px;">Upload photos of people wearing complete outfits (top + bottom)</p>
        <input type="file" id="outfitsInput" accept="image/*" multiple>
        <div id="outfitsPreview" class="preview-container"></div>
        <button id="uploadOutfitsBtn" style="display: none;">Upload Outfits</button>
    </div>

    <pre id="output"></pre>
    
    <!-- Gallery Section -->
    <div class="gallery-section">
        <h2>Currently Uploaded Tops</h2>
        <button id="refreshTops">Refresh Tops</button>
        <div id="topsGallery" class="gallery-container"></div>
    </div>
    
    <div class="gallery-section">
        <h2>Currently Uploaded Bottoms</h2>
        <button id="refreshBottoms">Refresh Bottoms</button>
        <div id="bottomsGallery" class="gallery-container"></div>
    </div>

    <div class="gallery-section">
        <h2>Complete Outfits Database</h2>
        <button id="refreshOutfits">Refresh Outfits</button>
        <div id="outfitsGallery" class="gallery-container"></div>
    </div>

    <!-- Generate Outfits Section -->
    <div class="gallery-section">
        <h2>Generate Outfits</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
            <button id="generateRandomBtn">Generate Random Outfit</button>
            <button id="generatePickedBtn">Generate Based on Picked Clothing</button>
            <button id="generateSimilarityBtn">Generate for Me (Similarity)</button>
            <button id="generateDatasetBtn">Generate for Me (Dataset)</button>
            <button id="findOutfitFromItemBtn" style="background-color: #4CAF50;">Find Outfit From My Item</button>
        </div>
    </div>

    <!-- Modal for displaying generated outfit -->
    <div id="outfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Your Generated Outfit</h2>
            <div class="outfit-display">
                <div class="outfit-item">
                    <h4>Top</h4>
                    <img id="outfitTopImg" alt="Top clothing item">
                    <p id="outfitTopName"></p>
                </div>
                <div class="outfit-item">
                    <h4>Bottom</h4>
                    <img id="outfitBottomImg" alt="Bottom clothing item">
                    <p id="outfitBottomName"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Wardrobe selection modal -->
    <div id="wardrobeModal" class="modal">
        <div class="wardrobe-modal-content">
            <span class="close-modal" id="closeWardrobe">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Wardrobe</h2>

            <div class="wardrobe-section">
                <h3>Tops</h3>
                <div id="wardrobeTopsGrid" class="wardrobe-grid"></div>
            </div>

            <div class="wardrobe-section">
                <h3>Bottoms</h3>
                <div id="wardrobeBottomsGrid" class="wardrobe-grid"></div>
            </div>

            <button id="wardrobeConfirmBtn" class="wardrobe-confirm-btn" disabled>Confirm</button>
        </div>
    </div>

    <!-- Duplicate detection modal -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" id="closeDuplicate">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Duplicate Detected</h2>

            <p id="duplicateMessage" style="text-align: center; margin-bottom: 20px; font-size: 1.1em;"></p>

            <div class="outfit-display" style="margin-bottom: 20px;">
                <div class="outfit-item">
                    <h4>Your Image</h4>
                    <img id="duplicateNewImg" alt="New image" style="max-height: 300px;">
                </div>
                <div class="outfit-item">
                    <h4>Existing Image</h4>
                    <img id="duplicateExistingImg" alt="Existing image" style="max-height: 300px;">
                </div>
            </div>

            <div id="duplicateButtonContainer" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button id="duplicateOverwriteBtn" style="background-color: #ff6b6b; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer;">Overwrite</button>
                <button id="duplicateRenameBtn" style="background-color: #4CAF50; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; display: none;">Rename</button>
                <button id="duplicateCancelBtn" style="background-color: #999; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer;">Cancel</button>
            </div>

            <div id="renameInputContainer" style="display: none; margin-top: 20px; text-align: center;">
                <input type="text" id="duplicateNewFilename" placeholder="Enter new filename" style="padding: 10px; width: 300px; margin-right: 10px;">
                <button id="duplicateConfirmRenameBtn" style="background-color: #4CAF50; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer;">Confirm Rename</button>
            </div>
        </div>
    </div>

    <!-- Find Outfit From Item Modal -->
    <div id="findOutfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeFindOutfit">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Find Outfit From Your Item</h2>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px;">Upload a clothing item to find a matching complete outfit:</p>
                <div style="margin-bottom: 15px;">
                    <label>Select Category:</label><br>
                    <select id="findOutfitCategory" style="padding: 8px; margin-top: 5px; width: 100%; font-size: 16px;">
                        <option value="top">Top</option>
                        <option value="bottom">Bottom</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Upload Image:</label><br>
                    <input type="file" id="findOutfitFileInput" accept="image/*" style="margin-top: 5px;">
                </div>
                <div id="findOutfitPreview" style="margin-bottom: 15px; text-align: center;"></div>
                <button id="findOutfitSearchBtn" style="width: 100%; padding: 12px; font-size: 16px;">Search for Matching Outfit</button>
            </div>
        </div>
    </div>

    <!-- Found Outfit Result Modal -->
    <div id="foundOutfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeFoundOutfit">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Recommendation From Your Closet</h2>
            <div style="padding: 20px;">
                <p id="foundOutfitMessage" style="font-size: 1.1em; margin-bottom: 20px; text-align: center;"></p>

                <div class="outfit-display" style="display: flex; justify-content: space-around; gap: 30px; margin: 20px 0;">
                    <div class="outfit-item" style="flex: 1; text-align: center;">
                        <h4>Your Item</h4>
                        <img id="uploadedItemImg" style="max-width: 200px; height: auto; border-radius: 8px;" alt="Your clothing item">
                        <p id="uploadedItemCategory" style="margin-top: 10px; font-weight: bold;"></p>
                    </div>

                    <div style="display: flex; align-items: center; font-size: 2em; color: #666;">+</div>

                    <div class="outfit-item" style="flex: 1; text-align: center;">
                        <h4>Recommended Match</h4>
                        <img id="recommendedItemImg" style="max-width: 200px; height: auto; border-radius: 8px;" alt="Recommended item">
                        <p id="recommendedItemName" style="margin-top: 10px; font-weight: bold;"></p>
                        <p id="recommendedItemSimilarity" style="margin-top: 5px; font-size: 0.9em; color: #666;"></p>
                    </div>
                </div>

                <div id="confidenceWarning" style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px; display: none;">
                    <strong>⚠️ Low Confidence Match</strong>
                    <p id="confidenceMessage" style="margin: 5px 0 0 0;"></p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button id="viewReferenceOutfitBtn" style="padding: 10px 20px; font-size: 14px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        View Reference Outfit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let topsFiles = [];
        let bottomsFiles = [];
        let outfitsFiles = [];
        let selectedItem = null; // {id: number, category: 'top'|'bottom'}

        // Handle tops file selection
        document.getElementById('topsInput').addEventListener('change', (e) => {
            topsFiles = Array.from(e.target.files);
            displayPreviews(topsFiles, 'topsPreview');
            document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
        });

        // Handle bottoms file selection
        document.getElementById('bottomsInput').addEventListener('change', (e) => {
            bottomsFiles = Array.from(e.target.files);
            displayPreviews(bottomsFiles, 'bottomsPreview');
            document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
        });

        // Handle outfits file selection
        document.getElementById('outfitsInput').addEventListener('change', (e) => {
            outfitsFiles = Array.from(e.target.files);
            displayPreviews(outfitsFiles, 'outfitsPreview');
            document.getElementById('uploadOutfitsBtn').style.display = outfitsFiles.length > 0 ? 'block' : 'none';
        });
        
        // Display image previews
        function displayPreviews(files, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'X';
                    removeBtn.onclick = () => removePreview(index, containerId);
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    container.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Remove image from preview
        function removePreview(index, containerId) {
            if (containerId === 'topsPreview') {
                topsFiles.splice(index, 1);
                displayPreviews(topsFiles, 'topsPreview');
                document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
            } else if (containerId === 'bottomsPreview') {
                bottomsFiles.splice(index, 1);
                displayPreviews(bottomsFiles, 'bottomsPreview');
                document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
            } else if (containerId === 'outfitsPreview') {
                outfitsFiles.splice(index, 1);
                displayPreviews(outfitsFiles, 'outfitsPreview');
                document.getElementById('uploadOutfitsBtn').style.display = outfitsFiles.length > 0 ? 'block' : 'none';
            }
        }
        
        // Upload tops
        document.getElementById('uploadTopsBtn').addEventListener('click', async () => {
            await uploadImages(topsFiles, 'top');
            topsFiles = [];
            document.getElementById('topsPreview').innerHTML = '';
            document.getElementById('topsInput').value = '';
            document.getElementById('uploadTopsBtn').style.display = 'none';
            loadGallery('top');
        });
        
        // Upload bottoms
        document.getElementById('uploadBottomsBtn').addEventListener('click', async () => {
            await uploadImages(bottomsFiles, 'bottom');
            bottomsFiles = [];
            document.getElementById('bottomsPreview').innerHTML = '';
            document.getElementById('bottomsInput').value = '';
            document.getElementById('uploadBottomsBtn').style.display = 'none';
            loadGallery('bottom');
        });

        // Upload outfits
        document.getElementById('uploadOutfitsBtn').addEventListener('click', async () => {
            await uploadOutfits(outfitsFiles);
            outfitsFiles = [];
            document.getElementById('outfitsPreview').innerHTML = '';
            document.getElementById('outfitsInput').value = '';
            document.getElementById('uploadOutfitsBtn').style.display = 'none';
            loadOutfitGallery();
        });

        // Upload images function
        async function uploadImages(files, category) {
            const results = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });

                    // Handle 409 Conflict (duplicate detected)
                    if (response.status === 409) {
                        const errorData = await response.json();
                        const duplicateData = errorData.detail;

                        // Show duplicate modal with images and options
                        await handleDuplicate(file, duplicateData, category);
                        continue;
                    }

                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }

        // Handle duplicate detection dialog
        async function handleDuplicate(newFile, duplicateData, category) {
            return new Promise((resolve) => {
                const modal = document.getElementById('duplicateModal');
                const messageEl = document.getElementById('duplicateMessage');
                const existingImgEl = document.getElementById('duplicateExistingImg');
                const newImgEl = document.getElementById('duplicateNewImg');
                const overwriteBtn = document.getElementById('duplicateOverwriteBtn');
                const renameBtn = document.getElementById('duplicateRenameBtn');
                const cancelBtn = document.getElementById('duplicateCancelBtn');
                const renameInputContainer = document.getElementById('renameInputContainer');
                const renameInput = document.getElementById('duplicateNewFilename');
                const confirmRenameBtn = document.getElementById('duplicateConfirmRenameBtn');

                // Display message
                messageEl.textContent = duplicateData.message;

                // Display new image
                const newReader = new FileReader();
                newReader.onload = (e) => {
                    newImgEl.src = e.target.result;
                };
                newReader.readAsDataURL(newFile);

                // Display existing image
                existingImgEl.src = `http://127.0.0.1:8000/get-image/${category}/${duplicateData.existing_id}`;

                // Reset rename input
                renameInputContainer.style.display = 'none';
                renameInput.value = '';

                // Show/hide Rename button based on duplicate type
                // Only show Rename for filename duplicates, not for content duplicates
                // Content duplicates (same image) means renaming won't help - still same image
                renameBtn.style.display = (duplicateData.type === 'filename_duplicate') ? 'block' : 'none';

                // Show modal
                modal.style.display = 'block';

                // Handle overwrite
                overwriteBtn.onclick = async () => {
                    modal.style.display = 'none';
                    // Delete existing image first
                    await fetch(`http://127.0.0.1:8000/delete-image/${category}/${duplicateData.existing_id}`, {
                        method: 'DELETE'
                    });
                    // Then upload new image with same filename
                    const formData = new FormData();
                    formData.append('file', newFile);
                    formData.append('category', category);
                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    console.log('Upload after overwrite:', result);
                    loadGallery(category);
                    resolve();
                };

                // Handle rename
                renameBtn.onclick = () => {
                    renameInputContainer.style.display = 'block';
                    renameInput.focus();
                    renameInput.value = newFile.name.replace(/\.[^.]+$/, ''); // Pre-fill with filename without extension
                };

                // Handle confirm rename
                confirmRenameBtn.onclick = async () => {
                    const newFilename = renameInput.value.trim();
                    if (!newFilename) {
                        alert('Please enter a filename');
                        return;
                    }

                    // Get file extension from original file
                    const extension = newFile.name.substring(newFile.name.lastIndexOf('.'));
                    const fullNewFilename = newFilename + extension;

                    // Create new file with renamed filename
                    const renamedFile = new File([newFile], fullNewFilename, { type: newFile.type });

                    // Upload with new filename
                    const formData = new FormData();
                    formData.append('file', renamedFile);
                    formData.append('category', category);

                    try {
                        const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.status === 409) {
                            // Still a duplicate after rename - show error
                            const newErrorData = await response.json();
                            alert('Renamed file is still a duplicate: ' + newErrorData.detail.message);
                            return;
                        }

                        const result = await response.json();
                        console.log('Upload after rename:', result);
                        modal.style.display = 'none';
                        loadGallery(category);
                        resolve();
                    } catch (error) {
                        console.error('Rename upload error:', error);
                        alert('Error uploading renamed file');
                    }
                };

                // Handle cancel
                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve();
                };

                // Handle close button
                document.getElementById('closeDuplicate').onclick = () => {
                    modal.style.display = 'none';
                    resolve();
                };
            });
        }

        // Upload outfits function
        async function uploadOutfits(files) {
            const results = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-outfit/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Outfit upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }

        // Load gallery
        async function loadGallery(category) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/get-images/${category}`);
                const images = await response.json();
                const containerId = category === 'top' ? 'topsGallery' : 'bottomsGallery';
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                for (const img of images) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-image/${category}/${img.id}`;
                    
                    const filename = document.createElement('div');
                    filename.className = 'filename';
                    filename.textContent = img.filename;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteImage(img.id, category);
                    
                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(deleteBtn);
                    galleryItem.appendChild(filename);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
            }
        }

        // Load outfit gallery
        async function loadOutfitGallery() {
            try {
                const response = await fetch('http://127.0.0.1:8000/get-outfits/');
                const outfits = await response.json();
                const container = document.getElementById('outfitsGallery');
                container.innerHTML = '';

                for (const outfit of outfits) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';

                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-outfit/${outfit.id}`;

                    const info = document.createElement('div');
                    info.className = 'filename';
                    info.textContent = `Outfit #${outfit.id}`;

                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(info);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading outfit gallery:', error);
            }
        }

        // Delete image
        async function deleteImage(imageId, category) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://127.0.0.1:8000/delete-image/${category}/${imageId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                document.getElementById('output').textContent = JSON.stringify(result, null, 2);
                loadGallery(category);
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Refresh buttons
        document.getElementById('refreshTops').addEventListener('click', () => loadGallery('top'));
        document.getElementById('refreshBottoms').addEventListener('click', () => loadGallery('bottom'));
        document.getElementById('refreshOutfits').addEventListener('click', () => loadOutfitGallery());

        // Load galleries on page load
        window.addEventListener('load', () => {
            loadGallery('top');
            loadGallery('bottom');
            loadOutfitGallery();
        });
        
        // Modal functionality
        const modal = document.getElementById('outfitModal');
        const closeModal = document.getElementById('closeModal');
        const wardrobeModal = document.getElementById('wardrobeModal');
        const closeWardrobe = document.getElementById('closeWardrobe');
        const findOutfitModal = document.getElementById('findOutfitModal');
        const closeFindOutfit = document.getElementById('closeFindOutfit');
        const foundOutfitModal = document.getElementById('foundOutfitModal');
        const closeFoundOutfit = document.getElementById('closeFoundOutfit');

        // Close outfit modal when X is clicked
        closeModal.onclick = function() {
            modal.style.display = 'none';
        }

        // Close wardrobe modal when X is clicked
        closeWardrobe.onclick = function() {
            wardrobeModal.style.display = 'none';
            selectedItem = null;
        }

        // Close find outfit modal when X is clicked
        closeFindOutfit.onclick = function() {
            findOutfitModal.style.display = 'none';
            document.getElementById('findOutfitFileInput').value = '';
            document.getElementById('findOutfitPreview').innerHTML = '';
        }

        // Close found outfit modal when X is clicked
        closeFoundOutfit.onclick = function() {
            foundOutfitModal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === wardrobeModal) {
                wardrobeModal.style.display = 'none';
                selectedItem = null;
            }
            if (event.target === findOutfitModal) {
                findOutfitModal.style.display = 'none';
                document.getElementById('findOutfitFileInput').value = '';
                document.getElementById('findOutfitPreview').innerHTML = '';
            }
            if (event.target === foundOutfitModal) {
                foundOutfitModal.style.display = 'none';
            }
        }

        // Load wardrobe items into modal
        async function loadWardrobeModal() {
            try {
                // Fetch tops and bottoms
                const topsResponse = await fetch('http://127.0.0.1:8000/get-images/top');
                const bottomsResponse = await fetch('http://127.0.0.1:8000/get-images/bottom');
                
                const tops = await topsResponse.json();
                const bottoms = await bottomsResponse.json();
                
                // Populate tops grid
                const topsGrid = document.getElementById('wardrobeTopsGrid');
                topsGrid.innerHTML = '';
                tops.forEach(top => {
                    const item = createWardrobeItem(top, 'top');
                    topsGrid.appendChild(item);
                });
                
                // Populate bottoms grid
                const bottomsGrid = document.getElementById('wardrobeBottomsGrid');
                bottomsGrid.innerHTML = '';
                bottoms.forEach(bottom => {
                    const item = createWardrobeItem(bottom, 'bottom');
                    bottomsGrid.appendChild(item);
                });
                
                // Show modal
                wardrobeModal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading wardrobe:', error);
                alert('Failed to load wardrobe items');
            }
        }

        // Create wardrobe item element
        function createWardrobeItem(itemData, category) {
            const item = document.createElement('div');
            item.className = 'wardrobe-item';
            item.dataset.id = itemData.id;
            item.dataset.category = category;
            
            const img = document.createElement('img');
            img.src = `http://127.0.0.1:8000/get-image/${category}/${itemData.id}`;
            img.alt = itemData.filename;
            
            const name = document.createElement('div');
            name.className = 'item-name';
            name.textContent = itemData.filename;
            
            item.appendChild(img);
            item.appendChild(name);
            
            // Click handler for selection
            item.addEventListener('click', () => {
                // Deselect all items
                document.querySelectorAll('.wardrobe-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Select this item
                item.classList.add('selected');
                selectedItem = {
                    id: itemData.id,
                    category: category,
                    filename: itemData.filename
                };
                
                // Enable confirm button
                document.getElementById('wardrobeConfirmBtn').disabled = false;
            });
            
            return item;
        }

        // Confirm wardrobe selection and generate outfit
        document.getElementById('wardrobeConfirmBtn').addEventListener('click', async () => {
            if (!selectedItem) return;
            
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-picked-outfit/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: selectedItem.id,
                        item_category: selectedItem.category
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }
                
                const outfit = await response.json();
                
                // Close wardrobe modal
                wardrobeModal.style.display = 'none';
                
                // Display outfit in result modal
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;
                
                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;
                
                // Show outfit modal
                modal.style.display = 'block';
                
                // Reset selection
                selectedItem = null;
                document.getElementById('wardrobeConfirmBtn').disabled = true;
                
            } catch (error) {
                console.error('Error generating outfit:', error);
                alert('Failed to generate outfit');
            }
        });

        // Generate Random Outfit
        document.getElementById('generateRandomBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-random-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating random outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        // Generate Based on Picked Clothing
        document.getElementById('generatePickedBtn').addEventListener('click', () => {
            loadWardrobeModal();
        });
        
        // Generate Similarity-Based Outfit
        document.getElementById('generateSimilarityBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-similarity-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = `${outfit.bottom.filename} (Similarity: ${(outfit.similarity_score * 100).toFixed(1)}%)`;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating similarity-based outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        document.getElementById('generateDatasetBtn').addEventListener('click', () => {
            console.log('Generate for Me (Dataset) clicked');
            // TODO: Add dataset-based outfit generation functionality
        });

        // Find Outfit From Item button
        document.getElementById('findOutfitFromItemBtn').addEventListener('click', () => {
            findOutfitModal.style.display = 'block';
        });

        // Store uploaded item data for display
        let uploadedItemData = null;

        // Handle file selection for find outfit - store preview data
        document.getElementById('findOutfitFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedItemData = event.target.result;
                    const preview = document.getElementById('findOutfitPreview');
                    preview.innerHTML = `<img src="${uploadedItemData}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Search for matching outfit
        document.getElementById('findOutfitSearchBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('findOutfitFileInput');
            const category = document.getElementById('findOutfitCategory').value;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select an image first');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', category);

            try {
                document.getElementById('findOutfitSearchBtn').textContent = 'Searching...';
                document.getElementById('findOutfitSearchBtn').disabled = true;

                const response = await fetch('http://127.0.0.1:8000/find-outfit-by-item/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to find matching outfit');
                    return;
                }

                const result = await response.json();

                // Close the find outfit modal
                findOutfitModal.style.display = 'none';

                // Display the recommendation from user's closet
                document.getElementById('foundOutfitMessage').textContent = result.message;

                // Show uploaded item
                document.getElementById('uploadedItemImg').src = uploadedItemData;
                document.getElementById('uploadedItemCategory').textContent =
                    `Your ${category.charAt(0).toUpperCase() + category.slice(1)}`;

                // Show recommended item from closet
                document.getElementById('recommendedItemImg').src =
                    `http://127.0.0.1:8000/get-image/${result.recommended_item.category}/${result.recommended_item.id}`;
                document.getElementById('recommendedItemName').textContent = result.recommended_item.filename;
                document.getElementById('recommendedItemSimilarity').textContent =
                    `Match Score: ${(result.recommended_item.similarity_to_outfit * 100).toFixed(1)}%`;

                // Handle confidence warnings
                const confidenceWarning = document.getElementById('confidenceWarning');
                if (result.confidence === 'low') {
                    confidenceWarning.style.display = 'block';
                    document.getElementById('confidenceMessage').textContent = result.confidence_message;
                } else {
                    confidenceWarning.style.display = 'none';
                }

                // Store reference outfit ID for viewing
                document.getElementById('viewReferenceOutfitBtn').onclick = () => {
                    window.open(`http://127.0.0.1:8000/get-outfit/${result.outfit_reference_id}`, '_blank');
                };

                // Show the result modal
                foundOutfitModal.style.display = 'block';

                // Reset form
                fileInput.value = '';
                document.getElementById('findOutfitPreview').innerHTML = '';
                uploadedItemData = null;

            } catch (error) {
                console.error('Error finding outfit:', error);
                alert('An error occurred while searching for outfit. Please try again.');
            } finally {
                document.getElementById('findOutfitSearchBtn').textContent = 'Search for Matching Outfit';
                document.getElementById('findOutfitSearchBtn').disabled = false;
            }
        });
    </script>
</body>
</html>