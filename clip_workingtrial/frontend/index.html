<!DOCTYPE html>
<html>
<head>
    <title>CLIP Image Similarity - Tops & Bottoms</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Upload Clothing Images</h1>
    
    <!-- Tops Upload Section -->
    <div class="upload-section">
        <h2>Upload Tops</h2>
        <input type="file" id="topsInput" accept="image/*" multiple>
        <div id="topsPreview" class="preview-container"></div>
        <button id="uploadTopsBtn" style="display: none;">Upload Tops</button>
    </div>
    
    <!-- Bottoms Upload Section -->
    <div class="upload-section">
        <h2>Upload Bottoms</h2>
        <input type="file" id="bottomsInput" accept="image/*" multiple>
        <div id="bottomsPreview" class="preview-container"></div>
        <button id="uploadBottomsBtn" style="display: none;">Upload Bottoms</button>
    </div>
    
    <pre id="output"></pre>
    
    <!-- Gallery Section -->
    <div class="gallery-section">
        <h2>Currently Uploaded Tops</h2>
        <button id="refreshTops">Refresh Tops</button>
        <div id="topsGallery" class="gallery-container"></div>
    </div>
    
    <div class="gallery-section">
        <h2>Currently Uploaded Bottoms</h2>
        <button id="refreshBottoms">Refresh Bottoms</button>
        <div id="bottomsGallery" class="gallery-container"></div>
    </div>
    
    <!-- Generate Outfits Section -->
    <div class="gallery-section">
        <h2>Generate Outfits</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
            <button id="generateRandomBtn">Generate Random Outfit</button>
            <button id="generatePickedBtn">Generate Based on Picked Clothing</button>
            <button id="generateSimilarityBtn">Generate for Me (Similarity)</button>
            <button id="generateDatasetBtn">Generate for Me (Dataset)</button>
        </div>
    </div>

    <!-- Modal for displaying generated outfit -->
    <div id="outfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Your Generated Outfit</h2>
            <div class="outfit-display">
                <div class="outfit-item">
                    <h4>Top</h4>
                    <img id="outfitTopImg" alt="Top clothing item">
                    <p id="outfitTopName"></p>
                </div>
                <div class="outfit-item">
                    <h4>Bottom</h4>
                    <img id="outfitBottomImg" alt="Bottom clothing item">
                    <p id="outfitBottomName"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Wardrobe selection modal -->
    <div id="wardrobeModal" class="modal">
        <div class="wardrobe-modal-content">
            <span class="close-modal" id="closeWardrobe">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Wardrobe</h2>
            
            <div class="wardrobe-section">
                <h3>Tops</h3>
                <div id="wardrobeTopsGrid" class="wardrobe-grid"></div>
            </div>
            
            <div class="wardrobe-section">
                <h3>Bottoms</h3>
                <div id="wardrobeBottomsGrid" class="wardrobe-grid"></div>
            </div>
            
            <button id="wardrobeConfirmBtn" class="wardrobe-confirm-btn" disabled>Confirm</button>
        </div>
    </div>

    <script>
        let topsFiles = [];
        let bottomsFiles = [];
        let selectedItem = null; // {id: number, category: 'top'|'bottom'}
        
        // Handle tops file selection
        document.getElementById('topsInput').addEventListener('change', (e) => {
            topsFiles = Array.from(e.target.files);
            displayPreviews(topsFiles, 'topsPreview');
            document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
        });
        
        // Handle bottoms file selection
        document.getElementById('bottomsInput').addEventListener('change', (e) => {
            bottomsFiles = Array.from(e.target.files);
            displayPreviews(bottomsFiles, 'bottomsPreview');
            document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
        });
        
        // Display image previews
        function displayPreviews(files, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'X';
                    removeBtn.onclick = () => removePreview(index, containerId);
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    container.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Remove image from preview
        function removePreview(index, containerId) {
            if (containerId === 'topsPreview') {
                topsFiles.splice(index, 1);
                displayPreviews(topsFiles, 'topsPreview');
                document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
            } else {
                bottomsFiles.splice(index, 1);
                displayPreviews(bottomsFiles, 'bottomsPreview');
                document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
            }
        }
        
        // Upload tops
        document.getElementById('uploadTopsBtn').addEventListener('click', async () => {
            await uploadImages(topsFiles, 'top');
            topsFiles = [];
            document.getElementById('topsPreview').innerHTML = '';
            document.getElementById('topsInput').value = '';
            document.getElementById('uploadTopsBtn').style.display = 'none';
            loadGallery('top');
        });
        
        // Upload bottoms
        document.getElementById('uploadBottomsBtn').addEventListener('click', async () => {
            await uploadImages(bottomsFiles, 'bottom');
            bottomsFiles = [];
            document.getElementById('bottomsPreview').innerHTML = '';
            document.getElementById('bottomsInput').value = '';
            document.getElementById('uploadBottomsBtn').style.display = 'none';
            loadGallery('bottom');
        });
        
        // Upload images function
        async function uploadImages(files, category) {
            const results = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);
                
                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }
        
        // Load gallery
        async function loadGallery(category) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/get-images/${category}`);
                const images = await response.json();
                const containerId = category === 'top' ? 'topsGallery' : 'bottomsGallery';
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                for (const img of images) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-image/${category}/${img.id}`;
                    
                    const filename = document.createElement('div');
                    filename.className = 'filename';
                    filename.textContent = img.filename;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteImage(img.id, category);
                    
                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(deleteBtn);
                    galleryItem.appendChild(filename);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
            }
        }
        
        // Delete image
        async function deleteImage(imageId, category) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://127.0.0.1:8000/delete-image/${category}/${imageId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                document.getElementById('output').textContent = JSON.stringify(result, null, 2);
                loadGallery(category);
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Refresh buttons
        document.getElementById('refreshTops').addEventListener('click', () => loadGallery('top'));
        document.getElementById('refreshBottoms').addEventListener('click', () => loadGallery('bottom'));
        
        // Load galleries on page load
        window.addEventListener('load', () => {
            loadGallery('top');
            loadGallery('bottom');
        });
        
        // Modal functionality
        const modal = document.getElementById('outfitModal');
        const closeModal = document.getElementById('closeModal');
        const wardrobeModal = document.getElementById('wardrobeModal');
        const closeWardrobe = document.getElementById('closeWardrobe');

        // Close outfit modal when X is clicked
        closeModal.onclick = function() {
            modal.style.display = 'none';
        }

        // Close wardrobe modal when X is clicked
        closeWardrobe.onclick = function() {
            wardrobeModal.style.display = 'none';
            selectedItem = null;
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === wardrobeModal) {
                wardrobeModal.style.display = 'none';
                selectedItem = null;
            }
        }

        // Load wardrobe items into modal
        async function loadWardrobeModal() {
            try {
                // Fetch tops and bottoms
                const topsResponse = await fetch('http://127.0.0.1:8000/get-images/top');
                const bottomsResponse = await fetch('http://127.0.0.1:8000/get-images/bottom');
                
                const tops = await topsResponse.json();
                const bottoms = await bottomsResponse.json();
                
                // Populate tops grid
                const topsGrid = document.getElementById('wardrobeTopsGrid');
                topsGrid.innerHTML = '';
                tops.forEach(top => {
                    const item = createWardrobeItem(top, 'top');
                    topsGrid.appendChild(item);
                });
                
                // Populate bottoms grid
                const bottomsGrid = document.getElementById('wardrobeBottomsGrid');
                bottomsGrid.innerHTML = '';
                bottoms.forEach(bottom => {
                    const item = createWardrobeItem(bottom, 'bottom');
                    bottomsGrid.appendChild(item);
                });
                
                // Show modal
                wardrobeModal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading wardrobe:', error);
                alert('Failed to load wardrobe items');
            }
        }

        // Create wardrobe item element
        function createWardrobeItem(itemData, category) {
            const item = document.createElement('div');
            item.className = 'wardrobe-item';
            item.dataset.id = itemData.id;
            item.dataset.category = category;
            
            const img = document.createElement('img');
            img.src = `http://127.0.0.1:8000/get-image/${category}/${itemData.id}`;
            img.alt = itemData.filename;
            
            const name = document.createElement('div');
            name.className = 'item-name';
            name.textContent = itemData.filename;
            
            item.appendChild(img);
            item.appendChild(name);
            
            // Click handler for selection
            item.addEventListener('click', () => {
                // Deselect all items
                document.querySelectorAll('.wardrobe-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Select this item
                item.classList.add('selected');
                selectedItem = {
                    id: itemData.id,
                    category: category,
                    filename: itemData.filename
                };
                
                // Enable confirm button
                document.getElementById('wardrobeConfirmBtn').disabled = false;
            });
            
            return item;
        }

        // Confirm wardrobe selection and generate outfit
        document.getElementById('wardrobeConfirmBtn').addEventListener('click', async () => {
            if (!selectedItem) return;
            
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-picked-outfit/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: selectedItem.id,
                        item_category: selectedItem.category
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }
                
                const outfit = await response.json();
                
                // Close wardrobe modal
                wardrobeModal.style.display = 'none';
                
                // Display outfit in result modal
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;
                
                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;
                
                // Show outfit modal
                modal.style.display = 'block';
                
                // Reset selection
                selectedItem = null;
                document.getElementById('wardrobeConfirmBtn').disabled = true;
                
            } catch (error) {
                console.error('Error generating outfit:', error);
                alert('Failed to generate outfit');
            }
        });

        // Generate Random Outfit
        document.getElementById('generateRandomBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-random-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating random outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        // Generate Based on Picked Clothing
        document.getElementById('generatePickedBtn').addEventListener('click', () => {
            loadWardrobeModal();
        });
        
        // Generate Similarity-Based Outfit
        document.getElementById('generateSimilarityBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-similarity-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = `${outfit.bottom.filename} (Similarity: ${(outfit.similarity_score * 100).toFixed(1)}%)`;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating similarity-based outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        document.getElementById('generateDatasetBtn').addEventListener('click', () => {
            console.log('Generate for Me (Dataset) clicked');
            // TODO: Add dataset-based outfit generation functionality
        });
    </script>
</body>
</html>