<!DOCTYPE html>
<html>
<head>
    <title>CLIP Image Similarity - Tops & Bottoms</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Upload Clothing Images</h1>
    
    <!-- Tops Upload Section -->
    <div class="upload-section">
        <h2>Upload Tops</h2>
        <input type="file" id="topsInput" accept="image/*" multiple>
        <div id="topsPreview" class="preview-container"></div>
        <button id="uploadTopsBtn" style="display: none;">Upload Tops</button>
    </div>
    
    <!-- Bottoms Upload Section -->
    <div class="upload-section">
        <h2>Upload Bottoms</h2>
        <input type="file" id="bottomsInput" accept="image/*" multiple>
        <div id="bottomsPreview" class="preview-container"></div>
        <button id="uploadBottomsBtn" style="display: none;">Upload Bottoms</button>
    </div>

    <!-- Outfits Upload Section -->
    <div class="upload-section">
        <h2>Upload Complete Outfits</h2>
        <p style="font-size: 0.9em; color: #666; margin-top: -10px;">Upload photos of people wearing complete outfits (top + bottom)</p>
        <input type="file" id="outfitsInput" accept="image/*" multiple>
        <div id="outfitsPreview" class="preview-container"></div>
        <button id="uploadOutfitsBtn" style="display: none;">Upload Outfits</button>
    </div>

    <pre id="output"></pre>
    
    <!-- Gallery Section -->
    <div class="gallery-section">
        <h2>Currently Uploaded Tops</h2>
        <button id="refreshTops">Refresh Tops</button>
        <div id="topsGallery" class="gallery-container"></div>
    </div>
    
    <div class="gallery-section">
        <h2>Currently Uploaded Bottoms</h2>
        <button id="refreshBottoms">Refresh Bottoms</button>
        <div id="bottomsGallery" class="gallery-container"></div>
    </div>

    <div class="gallery-section">
        <h2>Complete Outfits Database</h2>
        <button id="refreshOutfits">Refresh Outfits</button>
        <div id="outfitsGallery" class="gallery-container"></div>
    </div>

    <!-- Generate Outfits Section -->
    <div class="gallery-section">
        <h2>Generate Outfits</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
            <button id="generateRandomBtn">Generate Random Outfit</button>
            <button id="generatePickedBtn">Generate Based on Picked Clothing</button>
            <button id="generateSimilarityBtn">Generate for Me (Similarity)</button>
            <button id="generateDatasetBtn">Generate for Me (Dataset)</button>
            <button id="findOutfitFromItemBtn" style="background-color: #4CAF50;">Find Outfit From My Item</button>
        </div>
    </div>

    <!-- Modal for displaying generated outfit -->
    <div id="outfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Your Generated Outfit</h2>
            <p id="outfitCounter" style="text-align: center; color: #666; margin-bottom: 10px;">Outfit 1 of 15</p>
            <div class="outfit-display">
                <div class="outfit-item">
                    <h4>Top</h4>
                    <img id="outfitTopImg" alt="Top clothing item">
                    <p id="outfitTopName"></p>
                </div>
                <div class="outfit-item">
                    <h4>Bottom</h4>
                    <img id="outfitBottomImg" alt="Bottom clothing item">
                    <p id="outfitBottomName"></p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="nextOutfitBtn" style="padding: 10px 30px; font-size: 16px; cursor: pointer;">Next</button>
            </div>
        </div>
    </div>

    <!-- Wardrobe selection modal -->
    <div id="wardrobeModal" class="modal">
        <div class="wardrobe-modal-content">
            <span class="close-modal" id="closeWardrobe">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Wardrobe</h2>

            <div class="wardrobe-section">
                <h3>Tops</h3>
                <div id="wardrobeTopsGrid" class="wardrobe-grid"></div>
            </div>

            <div class="wardrobe-section">
                <h3>Bottoms</h3>
                <div id="wardrobeBottomsGrid" class="wardrobe-grid"></div>
            </div>

            <button id="wardrobeConfirmBtn" class="wardrobe-confirm-btn" disabled>Confirm</button>
        </div>
    </div>

    <!-- Duplicate detection modal -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" id="closeDuplicate">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Duplicate Detected</h2>

            <p id="duplicateMessage" style="text-align: center; margin-bottom: 20px; font-size: 1.1em;"></p>

            <div class="outfit-display" style="margin-bottom: 20px;">
                <div class="outfit-item">
                    <h4>Your Image</h4>
                    <img id="duplicateNewImg" alt="New image" style="max-height: 300px;">
                </div>
                <div class="outfit-item">
                    <h4>Existing Image</h4>
                    <img id="duplicateExistingImg" alt="Existing image" style="max-height: 300px;">
                </div>
            </div>

            <div id="duplicateButtonContainer" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button id="duplicateOverwriteBtn" style="background-color: #ff6b6b; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer;">Overwrite</button>
                <button id="duplicateAddSeparatelyBtn" style="background-color: #2196F3; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; display: none;">Add Separately</button>
                <button id="duplicateRenameBtn" style="background-color: #4CAF50; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; display: none;">Rename</button>
                <button id="duplicateCancelBtn" style="background-color: #999; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer;">Cancel</button>
            </div>

            <div id="renameInputContainer" style="display: none; margin-top: 20px; text-align: center;">
                <input type="text" id="duplicateNewFilename" placeholder="Enter new filename" style="padding: 10px; width: 300px; margin-right: 10px;">
                <button id="duplicateConfirmRenameBtn" style="background-color: #4CAF50; padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer;">Confirm Rename</button>
            </div>
        </div>
    </div>

    <!-- Find Outfit From Item Modal -->
    <div id="findOutfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeFindOutfit">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Find Outfit From Your Item</h2>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px;">Find a matching complete outfit from your item:</p>

                <!-- Selection Mode -->
                <div style="margin-bottom: 20px; border: 2px solid #007bff; border-radius: 8px; padding: 15px; background-color: #f8f9fa;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">Choose Source:</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="cursor: pointer;">
                            <input type="radio" name="findOutfitMode" value="upload" checked style="margin-right: 5px;">
                            Upload from Computer
                        </label>
                        <label style="cursor: pointer;">
                            <input type="radio" name="findOutfitMode" value="closet" style="margin-right: 5px;">
                            Select from Closet
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Select Category:</label><br>
                    <select id="findOutfitCategory" style="padding: 8px; margin-top: 5px; width: 100%; font-size: 16px;">
                        <option value="top">Top</option>
                        <option value="bottom">Bottom</option>
                    </select>
                </div>

                <!-- Upload Mode Section -->
                <div id="uploadModeSection">
                    <div style="margin-bottom: 15px;">
                        <label>Upload Image:</label><br>
                        <input type="file" id="findOutfitFileInput" accept="image/*" style="margin-top: 5px;">
                    </div>
                    <div id="findOutfitPreview" style="margin-bottom: 15px; text-align: center;"></div>
                </div>

                <!-- Closet Mode Section -->
                <div id="closetModeSection" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold;">Select from Your Closet:</label>
                        <div id="findOutfitClosetGrid" class="wardrobe-grid" style="margin-top: 10px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;"></div>
                    </div>
                </div>

                <button id="findOutfitSearchBtn" style="width: 100%; padding: 12px; font-size: 16px;">Search for Matching Outfit</button>
            </div>
        </div>
    </div>

    <!-- Found Outfit Result Modal -->
    <div id="foundOutfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeFoundOutfit">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Recommendation From Your Closet</h2>
            <p id="foundOutfitCounter" style="text-align: center; color: #666; margin-bottom: 10px;">Outfit 1 of 15</p>
            <div style="padding: 20px;">
                <p id="foundOutfitMessage" style="font-size: 1.1em; margin-bottom: 20px; text-align: center;"></p>

                <div class="outfit-display" style="display: flex; justify-content: space-around; gap: 30px; margin: 20px 0;">
                    <div class="outfit-item" style="flex: 1; text-align: center;">
                        <h4>Your Item</h4>
                        <img id="uploadedItemImg" style="max-width: 200px; height: auto; border-radius: 8px;" alt="Your clothing item">
                        <p id="uploadedItemCategory" style="margin-top: 10px; font-weight: bold;"></p>
                    </div>

                    <div style="display: flex; align-items: center; font-size: 2em; color: #666;">+</div>

                    <div class="outfit-item" style="flex: 1; text-align: center;">
                        <h4>Recommended Match</h4>
                        <img id="recommendedItemImg" style="max-width: 200px; height: auto; border-radius: 8px;" alt="Recommended item">
                        <p id="recommendedItemName" style="margin-top: 10px; font-weight: bold;"></p>
                        <p id="recommendedItemSimilarity" style="margin-top: 5px; font-size: 0.9em; color: #666;"></p>
                    </div>
                </div>

                <div id="confidenceWarning" style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px; display: none;">
                    <strong>⚠️ Low Confidence Match</strong>
                    <p id="confidenceMessage" style="margin: 5px 0 0 0;"></p>
                </div>

                <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button id="viewReferenceOutfitBtn" style="padding: 10px 20px; font-size: 14px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        View Reference Outfit
                    </button>
                    <button id="nextFoundOutfitBtn" style="padding: 10px 30px; font-size: 16px; cursor: pointer;">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let topsFiles = [];
        let bottomsFiles = [];
        let outfitsFiles = [];
        let selectedItem = null; // {id: number, category: 'top'|'bottom'}

        // Handle tops file selection
        document.getElementById('topsInput').addEventListener('change', (e) => {
            topsFiles = Array.from(e.target.files);
            displayPreviews(topsFiles, 'topsPreview');
            document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
        });

        // Handle bottoms file selection
        document.getElementById('bottomsInput').addEventListener('change', (e) => {
            bottomsFiles = Array.from(e.target.files);
            displayPreviews(bottomsFiles, 'bottomsPreview');
            document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
        });

        // Handle outfits file selection
        document.getElementById('outfitsInput').addEventListener('change', (e) => {
            outfitsFiles = Array.from(e.target.files);
            displayPreviews(outfitsFiles, 'outfitsPreview');
            document.getElementById('uploadOutfitsBtn').style.display = outfitsFiles.length > 0 ? 'block' : 'none';
        });
        
        // Display image previews
        function displayPreviews(files, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'X';
                    removeBtn.onclick = () => removePreview(index, containerId);
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    container.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Remove image from preview
        function removePreview(index, containerId) {
            if (containerId === 'topsPreview') {
                topsFiles.splice(index, 1);
                displayPreviews(topsFiles, 'topsPreview');
                document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
            } else if (containerId === 'bottomsPreview') {
                bottomsFiles.splice(index, 1);
                displayPreviews(bottomsFiles, 'bottomsPreview');
                document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
            } else if (containerId === 'outfitsPreview') {
                outfitsFiles.splice(index, 1);
                displayPreviews(outfitsFiles, 'outfitsPreview');
                document.getElementById('uploadOutfitsBtn').style.display = outfitsFiles.length > 0 ? 'block' : 'none';
            }
        }
        
        // Upload tops
        document.getElementById('uploadTopsBtn').addEventListener('click', async () => {
            await uploadImages(topsFiles, 'top');
            topsFiles = [];
            document.getElementById('topsPreview').innerHTML = '';
            document.getElementById('topsInput').value = '';
            document.getElementById('uploadTopsBtn').style.display = 'none';
            loadGallery('top');
        });
        
        // Upload bottoms
        document.getElementById('uploadBottomsBtn').addEventListener('click', async () => {
            await uploadImages(bottomsFiles, 'bottom');
            bottomsFiles = [];
            document.getElementById('bottomsPreview').innerHTML = '';
            document.getElementById('bottomsInput').value = '';
            document.getElementById('uploadBottomsBtn').style.display = 'none';
            loadGallery('bottom');
        });

        // Upload outfits
        document.getElementById('uploadOutfitsBtn').addEventListener('click', async () => {
            await uploadOutfits(outfitsFiles);
            outfitsFiles = [];
            document.getElementById('outfitsPreview').innerHTML = '';
            document.getElementById('outfitsInput').value = '';
            document.getElementById('uploadOutfitsBtn').style.display = 'none';
            loadOutfitGallery();
        });

        // Upload images function
        async function uploadImages(files, category) {
            const results = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });

                    // Handle 409 Conflict (duplicate detected)
                    if (response.status === 409) {
                        const errorData = await response.json();
                        const duplicateData = errorData.detail;

                        // Show duplicate modal with images and options
                        await handleDuplicate(file, duplicateData, category);
                        continue;
                    }

                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }

        // Handle duplicate detection dialog
        async function handleDuplicate(newFile, duplicateData, category) {
            return new Promise((resolve) => {
                const modal = document.getElementById('duplicateModal');
                const messageEl = document.getElementById('duplicateMessage');
                const existingImgEl = document.getElementById('duplicateExistingImg');
                const newImgEl = document.getElementById('duplicateNewImg');
                const overwriteBtn = document.getElementById('duplicateOverwriteBtn');
                const addSeparatelyBtn = document.getElementById('duplicateAddSeparatelyBtn');
                const renameBtn = document.getElementById('duplicateRenameBtn');
                const cancelBtn = document.getElementById('duplicateCancelBtn');
                const renameInputContainer = document.getElementById('renameInputContainer');
                const renameInput = document.getElementById('duplicateNewFilename');
                const confirmRenameBtn = document.getElementById('duplicateConfirmRenameBtn');

                // Display message
                messageEl.textContent = duplicateData.message;

                // Display new image
                const newReader = new FileReader();
                newReader.onload = (e) => {
                    newImgEl.src = e.target.result;
                };
                newReader.readAsDataURL(newFile);

                // Display existing image
                existingImgEl.src = `http://127.0.0.1:8000/get-image/${category}/${duplicateData.existing_id}`;

                // Reset rename input
                renameInputContainer.style.display = 'none';
                renameInput.value = '';

                // Show/hide buttons based on duplicate type
                if (duplicateData.type === 'filename_duplicate') {
                    // Filename duplicate: show Overwrite and Rename
                    addSeparatelyBtn.style.display = 'none';
                    renameBtn.style.display = 'block';
                } else if (duplicateData.type === 'content_duplicate') {
                    // Content duplicate: show Overwrite and Add Separately
                    addSeparatelyBtn.style.display = 'block';
                    renameBtn.style.display = 'none';
                }

                // Show modal
                modal.style.display = 'block';

                // Handle overwrite
                overwriteBtn.onclick = async () => {
                    modal.style.display = 'none';
                    // Delete existing image first
                    await fetch(`http://127.0.0.1:8000/delete-image/${category}/${duplicateData.existing_id}`, {
                        method: 'DELETE'
                    });
                    // Then upload new image with same filename
                    const formData = new FormData();
                    formData.append('file', newFile);
                    formData.append('category', category);
                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    console.log('Upload after overwrite:', result);
                    loadGallery(category);
                    resolve();
                };

                // Handle add separately (for content duplicates)
                addSeparatelyBtn.onclick = async () => {
                    modal.style.display = 'none';
                    // Rename file with timestamp to bypass filename check
                    const timestamp = Date.now();
                    const nameWithoutExt = newFile.name.substring(0, newFile.name.lastIndexOf('.'));
                    const extension = newFile.name.substring(newFile.name.lastIndexOf('.'));
                    const newFilename = `${nameWithoutExt}_${timestamp}${extension}`;

                    const renamedFile = new File([newFile], newFilename, { type: newFile.type });

                    const formData = new FormData();
                    formData.append('file', renamedFile);
                    formData.append('category', category);
                    formData.append('skip_content_check', 'true');  // Skip content duplicate check

                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        alert('Could not add separately: ' + (errorData.detail?.message || errorData.detail));
                        return;
                    }

                    const result = await response.json();
                    console.log('Upload after add separately:', result);
                    loadGallery(category);
                    resolve();
                };

                // Handle rename
                renameBtn.onclick = () => {
                    renameInputContainer.style.display = 'block';
                    renameInput.focus();
                    renameInput.value = newFile.name.replace(/\.[^.]+$/, ''); // Pre-fill with filename without extension
                };

                // Handle confirm rename
                confirmRenameBtn.onclick = async () => {
                    const newFilename = renameInput.value.trim();
                    if (!newFilename) {
                        alert('Please enter a filename');
                        return;
                    }

                    // Get file extension from original file
                    const extension = newFile.name.substring(newFile.name.lastIndexOf('.'));
                    const fullNewFilename = newFilename + extension;

                    // Create new file with renamed filename
                    const renamedFile = new File([newFile], fullNewFilename, { type: newFile.type });

                    // Upload with new filename
                    const formData = new FormData();
                    formData.append('file', renamedFile);
                    formData.append('category', category);

                    try {
                        const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.status === 409) {
                            // Still a duplicate after rename - show error
                            const newErrorData = await response.json();
                            alert('Renamed file is still a duplicate: ' + newErrorData.detail.message);
                            return;
                        }

                        const result = await response.json();
                        console.log('Upload after rename:', result);
                        modal.style.display = 'none';
                        loadGallery(category);
                        resolve();
                    } catch (error) {
                        console.error('Rename upload error:', error);
                        alert('Error uploading renamed file');
                    }
                };

                // Handle cancel
                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve();
                };

                // Handle close button
                document.getElementById('closeDuplicate').onclick = () => {
                    modal.style.display = 'none';
                    resolve();
                };
            });
        }

        // Upload outfits function
        async function uploadOutfits(files) {
            const results = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-outfit/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Outfit upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }

        // Load gallery
        async function loadGallery(category) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/get-images/${category}`);
                const images = await response.json();
                const containerId = category === 'top' ? 'topsGallery' : 'bottomsGallery';
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                for (const img of images) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-image/${category}/${img.id}`;
                    
                    const filename = document.createElement('div');
                    filename.className = 'filename';
                    filename.textContent = img.filename;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteImage(img.id, category);
                    
                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(deleteBtn);
                    galleryItem.appendChild(filename);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
            }
        }

        // Load outfit gallery
        async function loadOutfitGallery() {
            try {
                const response = await fetch('http://127.0.0.1:8000/get-outfits/');
                const outfits = await response.json();
                const container = document.getElementById('outfitsGallery');
                container.innerHTML = '';

                for (const outfit of outfits) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';

                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-outfit/${outfit.id}`;

                    const info = document.createElement('div');
                    info.className = 'filename';
                    info.textContent = `Outfit #${outfit.id}`;

                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(info);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading outfit gallery:', error);
            }
        }

        // Delete image
        async function deleteImage(imageId, category) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://127.0.0.1:8000/delete-image/${category}/${imageId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                document.getElementById('output').textContent = JSON.stringify(result, null, 2);
                loadGallery(category);
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Refresh buttons
        document.getElementById('refreshTops').addEventListener('click', () => loadGallery('top'));
        document.getElementById('refreshBottoms').addEventListener('click', () => loadGallery('bottom'));
        document.getElementById('refreshOutfits').addEventListener('click', () => loadOutfitGallery());

        // Load galleries on page load
        window.addEventListener('load', () => {
            loadGallery('top');
            loadGallery('bottom');
            loadOutfitGallery();
        });
        
        // Modal functionality
        const modal = document.getElementById('outfitModal');
        const closeModal = document.getElementById('closeModal');
        const wardrobeModal = document.getElementById('wardrobeModal');
        const closeWardrobe = document.getElementById('closeWardrobe');
        const findOutfitModal = document.getElementById('findOutfitModal');
        const closeFindOutfit = document.getElementById('closeFindOutfit');
        const foundOutfitModal = document.getElementById('foundOutfitModal');
        const closeFoundOutfit = document.getElementById('closeFoundOutfit');

        // Close outfit modal when X is clicked
        closeModal.onclick = function() {
            modal.style.display = 'none';
        }

        // Close wardrobe modal when X is clicked
        closeWardrobe.onclick = function() {
            wardrobeModal.style.display = 'none';
            selectedItem = null;
        }

        // Close find outfit modal when X is clicked
        closeFindOutfit.onclick = function() {
            findOutfitModal.style.display = 'none';
            resetFindOutfitModal();
        }

        // Function to reset find outfit modal
        function resetFindOutfitModal() {
            // Reset to upload mode
            document.querySelector('input[name="findOutfitMode"][value="upload"]').checked = true;
            document.getElementById('uploadModeSection').style.display = 'block';
            document.getElementById('closetModeSection').style.display = 'none';

            // Clear upload section
            document.getElementById('findOutfitFileInput').value = '';
            document.getElementById('findOutfitPreview').innerHTML = '';

            // Clear closet section
            document.getElementById('findOutfitClosetGrid').innerHTML = '';
            selectedClosetItem = null;

            // Note: We don't clear uploadedItemData here because it's still needed
            // for displaying in the found outfit modal after a successful search
        }

        // Close found outfit modal when X is clicked
        closeFoundOutfit.onclick = function() {
            foundOutfitModal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === wardrobeModal) {
                wardrobeModal.style.display = 'none';
                selectedItem = null;
            }
            if (event.target === findOutfitModal) {
                findOutfitModal.style.display = 'none';
                resetFindOutfitModal();
            }
            if (event.target === foundOutfitModal) {
                foundOutfitModal.style.display = 'none';
            }
        }

        // Load wardrobe items into modal
        async function loadWardrobeModal() {
            try {
                // Fetch tops and bottoms
                const topsResponse = await fetch('http://127.0.0.1:8000/get-images/top');
                const bottomsResponse = await fetch('http://127.0.0.1:8000/get-images/bottom');
                
                const tops = await topsResponse.json();
                const bottoms = await bottomsResponse.json();
                
                // Populate tops grid
                const topsGrid = document.getElementById('wardrobeTopsGrid');
                topsGrid.innerHTML = '';
                tops.forEach(top => {
                    const item = createWardrobeItem(top, 'top');
                    topsGrid.appendChild(item);
                });
                
                // Populate bottoms grid
                const bottomsGrid = document.getElementById('wardrobeBottomsGrid');
                bottomsGrid.innerHTML = '';
                bottoms.forEach(bottom => {
                    const item = createWardrobeItem(bottom, 'bottom');
                    bottomsGrid.appendChild(item);
                });
                
                // Show modal
                wardrobeModal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading wardrobe:', error);
                alert('Failed to load wardrobe items');
            }
        }

        // Create wardrobe item element
        function createWardrobeItem(itemData, category) {
            const item = document.createElement('div');
            item.className = 'wardrobe-item';
            item.dataset.id = itemData.id;
            item.dataset.category = category;
            
            const img = document.createElement('img');
            img.src = `http://127.0.0.1:8000/get-image/${category}/${itemData.id}`;
            img.alt = itemData.filename;
            
            const name = document.createElement('div');
            name.className = 'item-name';
            name.textContent = itemData.filename;
            
            item.appendChild(img);
            item.appendChild(name);
            
            // Click handler for selection
            item.addEventListener('click', () => {
                // Deselect all items
                document.querySelectorAll('.wardrobe-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Select this item
                item.classList.add('selected');
                selectedItem = {
                    id: itemData.id,
                    category: category,
                    filename: itemData.filename
                };
                
                // Enable confirm button
                document.getElementById('wardrobeConfirmBtn').disabled = false;
            });
            
            return item;
        }

        // Variables for outfit cycling
        let outfitSuggestions = [];
        let currentOutfitIndex = 0;
        let selectedItemData = null;
        let selectedCategory = null;
        let oppositeCategory = null;
        let shownOutfitIds = new Set(); // Track IDs of outfits already shown

        // Blank placeholder image (1x1 gray pixel)
        const blankImageData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';

        // Function to display current outfit
        function displayCurrentOutfit() {
            if (!outfitSuggestions || outfitSuggestions.length === 0) {
                return;
            }

            // Find next unique outfit
            let currentSuggestion = null;
            let foundUnique = false;

            while (currentOutfitIndex < outfitSuggestions.length) {
                currentSuggestion = outfitSuggestions[currentOutfitIndex];

                // Check if this outfit has already been shown
                if (!shownOutfitIds.has(currentSuggestion.id)) {
                    shownOutfitIds.add(currentSuggestion.id);
                    foundUnique = true;
                    break;
                }

                // Skip this duplicate and move to next
                currentOutfitIndex++;
            }

            const totalShown = shownOutfitIds.size;
            const totalOutfits = outfitSuggestions.length;

            // Update counter
            document.getElementById('outfitCounter').textContent = `Outfit ${totalShown} (${totalOutfits} total suggestions)`;

            // Display images based on selected category
            if (selectedCategory === 'top') {
                // Selected a top, showing different bottoms
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${selectedItemData.id}`;
                document.getElementById('outfitTopName').textContent = selectedItemData.filename;

                if (foundUnique) {
                    document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${currentSuggestion.id}`;
                    document.getElementById('outfitBottomName').textContent = currentSuggestion.filename;
                } else {
                    // No more unique outfits, show blank
                    document.getElementById('outfitBottomImg').src = blankImageData;
                    document.getElementById('outfitBottomName').textContent = 'No more unique bottoms available';
                }
            } else {
                // Selected a bottom, showing different tops
                if (foundUnique) {
                    document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${currentSuggestion.id}`;
                    document.getElementById('outfitTopName').textContent = currentSuggestion.filename;
                } else {
                    // No more unique outfits, show blank
                    document.getElementById('outfitTopImg').src = blankImageData;
                    document.getElementById('outfitTopName').textContent = 'No more unique tops available';
                }

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${selectedItemData.id}`;
                document.getElementById('outfitBottomName').textContent = selectedItemData.filename;
            }

            // Show/hide Next button and update text
            const nextBtn = document.getElementById('nextOutfitBtn');
            if (!foundUnique || currentOutfitIndex >= totalOutfits - 1) {
                nextBtn.textContent = 'No more outfit suggestions!';
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.textContent = 'Next';
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }

        // Next outfit button handler
        document.getElementById('nextOutfitBtn').addEventListener('click', () => {
            currentOutfitIndex++;
            displayCurrentOutfit();
        });

        // Confirm wardrobe selection and generate outfit
        document.getElementById('wardrobeConfirmBtn').addEventListener('click', async () => {
            if (!selectedItem) return;

            try {
                const response = await fetch('http://127.0.0.1:8000/generate-picked-outfit/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: selectedItem.id,
                        item_category: selectedItem.category
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const result = await response.json();

                // Store outfit data
                outfitSuggestions = result.suggestions;
                selectedItemData = result.selected_item;
                selectedCategory = result.selected_category;
                oppositeCategory = result.opposite_category;
                currentOutfitIndex = 0;
                shownOutfitIds.clear(); // Reset shown outfits for new generation

                // Close wardrobe modal
                wardrobeModal.style.display = 'none';

                // Display first outfit
                displayCurrentOutfit();

                // Show outfit modal
                modal.style.display = 'block';

                // Reset selection
                selectedItem = null;
                document.getElementById('wardrobeConfirmBtn').disabled = true;

            } catch (error) {
                console.error('Error generating outfit:', error);
                alert('Failed to generate outfit');
            }
        });

        // Generate Random Outfit
        document.getElementById('generateRandomBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-random-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating random outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        // Generate Based on Picked Clothing
        document.getElementById('generatePickedBtn').addEventListener('click', () => {
            loadWardrobeModal();
        });
        
        // Generate Similarity-Based Outfit
        document.getElementById('generateSimilarityBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-similarity-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = `${outfit.bottom.filename} (Similarity: ${(outfit.similarity_score * 100).toFixed(1)}%)`;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating similarity-based outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        document.getElementById('generateDatasetBtn').addEventListener('click', () => {
            console.log('Generate for Me (Dataset) clicked');
            // TODO: Add dataset-based outfit generation functionality
        });

        // Find Outfit From Item button
        document.getElementById('findOutfitFromItemBtn').addEventListener('click', () => {
            findOutfitModal.style.display = 'block';
        });

        // Store uploaded item data for display
        let uploadedItemData = null;
        let selectedClosetItem = null; // {id: number, category: 'top'|'bottom', filename: string}

        // Handle mode switching
        document.querySelectorAll('input[name="findOutfitMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                if (mode === 'upload') {
                    document.getElementById('uploadModeSection').style.display = 'block';
                    document.getElementById('closetModeSection').style.display = 'none';
                    selectedClosetItem = null;
                } else {
                    document.getElementById('uploadModeSection').style.display = 'none';
                    document.getElementById('closetModeSection').style.display = 'block';
                    loadFindOutfitClosetItems();
                }
            });
        });

        // Handle category change - reload closet items if in closet mode
        document.getElementById('findOutfitCategory').addEventListener('change', () => {
            const mode = document.querySelector('input[name="findOutfitMode"]:checked').value;
            if (mode === 'closet') {
                selectedClosetItem = null; // Clear selection when category changes
                loadFindOutfitClosetItems();
            }
        });

        // Load closet items for find outfit modal
        async function loadFindOutfitClosetItems() {
            const category = document.getElementById('findOutfitCategory').value;
            const grid = document.getElementById('findOutfitClosetGrid');
            grid.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';

            try {
                const response = await fetch(`http://127.0.0.1:8000/get-images/${category}`);
                const items = await response.json();

                grid.innerHTML = '';

                if (items.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #666;">No items in your closet for this category.</p>';
                    return;
                }

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'wardrobe-item';
                    itemDiv.dataset.id = item.id;
                    itemDiv.dataset.category = category;

                    const img = document.createElement('img');
                    img.src = `http://127.0.0.1:8000/get-image/${category}/${item.id}`;
                    img.alt = item.filename;

                    const name = document.createElement('div');
                    name.className = 'item-name';
                    name.textContent = item.filename;

                    itemDiv.appendChild(img);
                    itemDiv.appendChild(name);

                    // Click handler for selection
                    itemDiv.addEventListener('click', () => {
                        // Deselect all items
                        document.querySelectorAll('#findOutfitClosetGrid .wardrobe-item').forEach(el => {
                            el.classList.remove('selected');
                        });

                        // Select this item
                        itemDiv.classList.add('selected');
                        selectedClosetItem = {
                            id: item.id,
                            category: category,
                            filename: item.filename
                        };

                        // Store the image data for display later
                        uploadedItemData = img.src;
                    });

                    grid.appendChild(itemDiv);
                });

            } catch (error) {
                console.error('Error loading closet items:', error);
                grid.innerHTML = '<p style="text-align: center; color: red;">Failed to load closet items.</p>';
            }
        }

        // Handle file selection for find outfit - store preview data
        document.getElementById('findOutfitFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedItemData = event.target.result;
                    const preview = document.getElementById('findOutfitPreview');
                    preview.innerHTML = `<img src="${uploadedItemData}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Search for matching outfit
        // Variables for found outfit cycling
        let foundOutfitSuggestions = [];
        let currentFoundOutfitIndex = 0;
        let foundOutfitData = null;
        let shownFoundOutfitIds = new Set(); // Track IDs of found outfits already shown

        // Function to display current found outfit
        function displayCurrentFoundOutfit() {
            if (!foundOutfitSuggestions || foundOutfitSuggestions.length === 0) {
                return;
            }

            // Find next unique outfit
            let currentSuggestion = null;
            let foundUnique = false;

            while (currentFoundOutfitIndex < foundOutfitSuggestions.length) {
                currentSuggestion = foundOutfitSuggestions[currentFoundOutfitIndex];

                // Check if this outfit has already been shown
                if (!shownFoundOutfitIds.has(currentSuggestion.id)) {
                    shownFoundOutfitIds.add(currentSuggestion.id);
                    foundUnique = true;
                    break;
                }

                // Skip this duplicate and move to next
                currentFoundOutfitIndex++;
            }

            const totalShown = shownFoundOutfitIds.size;
            const totalOutfits = foundOutfitSuggestions.length;

            // Update counter
            document.getElementById('foundOutfitCounter').textContent =
                `Outfit ${totalShown} (${totalOutfits} total suggestions)`;

            // Show uploaded item
            document.getElementById('uploadedItemImg').src = uploadedItemData;
            document.getElementById('uploadedItemCategory').textContent =
                `Your ${foundOutfitData.uploaded_item_category.charAt(0).toUpperCase() + foundOutfitData.uploaded_item_category.slice(1)}`;

            // Show recommended item from closet
            if (foundUnique) {
                document.getElementById('recommendedItemImg').src =
                    `http://127.0.0.1:8000/get-image/${foundOutfitData.opposite_category}/${currentSuggestion.id}`;
                document.getElementById('recommendedItemName').textContent = currentSuggestion.filename;
                document.getElementById('recommendedItemSimilarity').textContent =
                    `Match Score: ${(currentSuggestion.similarity_to_outfit * 100).toFixed(1)}%`;

                // Update View Reference Outfit button to show current reference outfit
                document.getElementById('viewReferenceOutfitBtn').onclick = () => {
                    window.open(`http://127.0.0.1:8000/get-outfit/${currentSuggestion.reference_outfit_id}`, '_blank');
                };
                document.getElementById('viewReferenceOutfitBtn').style.display = 'inline-block';
            } else {
                // No more unique outfits, show blank
                document.getElementById('recommendedItemImg').src = blankImageData;
                document.getElementById('recommendedItemName').textContent =
                    `No more unique ${foundOutfitData.opposite_category}s available`;
                document.getElementById('recommendedItemSimilarity').textContent = '';
                document.getElementById('viewReferenceOutfitBtn').style.display = 'none';
            }

            // Show/hide Next button and update text
            const nextBtn = document.getElementById('nextFoundOutfitBtn');
            if (!foundUnique || currentFoundOutfitIndex >= totalOutfits - 1) {
                nextBtn.textContent = 'No more outfit suggestions!';
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.textContent = 'Next';
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }

        // Next found outfit button handler
        document.getElementById('nextFoundOutfitBtn').addEventListener('click', () => {
            currentFoundOutfitIndex++;
            displayCurrentFoundOutfit();
        });

        document.getElementById('findOutfitSearchBtn').addEventListener('click', async () => {
            const mode = document.querySelector('input[name="findOutfitMode"]:checked').value;
            const category = document.getElementById('findOutfitCategory').value;
            let file = null;

            // Validate based on mode
            if (mode === 'upload') {
                const fileInput = document.getElementById('findOutfitFileInput');
                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('Please select an image first');
                    return;
                }
                file = fileInput.files[0];
            } else {
                // Closet mode
                if (!selectedClosetItem) {
                    alert('Please select an item from your closet');
                    return;
                }

                // Fetch the image blob from the server and create a file
                try {
                    const imageResponse = await fetch(`http://127.0.0.1:8000/get-image/${selectedClosetItem.category}/${selectedClosetItem.id}`);
                    const blob = await imageResponse.blob();
                    file = new File([blob], selectedClosetItem.filename, { type: blob.type });
                } catch (error) {
                    console.error('Error fetching closet item image:', error);
                    alert('Failed to load selected item from closet');
                    return;
                }
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', category);

            try {
                document.getElementById('findOutfitSearchBtn').textContent = 'Searching...';
                document.getElementById('findOutfitSearchBtn').disabled = true;

                const response = await fetch('http://127.0.0.1:8000/find-outfit-by-item/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to find matching outfit');
                    return;
                }

                const result = await response.json();

                // Store outfit data for cycling
                foundOutfitSuggestions = result.suggestions;
                currentFoundOutfitIndex = 0;
                foundOutfitData = result;
                shownFoundOutfitIds.clear(); // Reset shown outfits for new search

                // Close the find outfit modal
                findOutfitModal.style.display = 'none';
                resetFindOutfitModal();

                // Display the recommendation from user's closet
                document.getElementById('foundOutfitMessage').textContent = result.message;

                // Handle confidence warnings
                const confidenceWarning = document.getElementById('confidenceWarning');
                if (result.confidence === 'low') {
                    confidenceWarning.style.display = 'block';
                    document.getElementById('confidenceMessage').textContent = result.confidence_message;
                } else {
                    confidenceWarning.style.display = 'none';
                }

                // Display first outfit (this will also set the reference outfit button)
                displayCurrentFoundOutfit();

                // Show the result modal
                foundOutfitModal.style.display = 'block';

            } catch (error) {
                console.error('Error finding outfit:', error);
                alert('An error occurred while searching for outfit. Please try again.');
            } finally {
                document.getElementById('findOutfitSearchBtn').textContent = 'Search for Matching Outfit';
                document.getElementById('findOutfitSearchBtn').disabled = false;
            }
        });
    </script>
</body>
</html>