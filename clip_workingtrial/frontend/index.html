<!DOCTYPE html>
<html>
<head>
    <title>CLIP Image Similarity - Tops & Bottoms</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Upload Clothing Images</h1>
    
    <!-- Tops Upload Section -->
    <div class="upload-section">
        <h2>Upload Tops</h2>
        <input type="file" id="topsInput" accept="image/*" multiple>
        <div style="margin: 10px 0;">
            <label>Temperature Tag:</label>
            <select id="topsTemperatureTag" style="padding: 8px; margin-left: 10px; font-size: 16px;">
                <option value="">-- Select (Optional) --</option>
                <option value="cold">‚ùÑÔ∏è Cold (< 50¬∞F / 10¬∞C)</option>
                <option value="cool">üçÇ Cool (50-65¬∞F / 10-18¬∞C)</option>
                <option value="mild">üå§Ô∏è Mild (65-75¬∞F / 18-24¬∞C)</option>
                <option value="warm">‚òÄÔ∏è Warm (75-85¬∞F / 24-29¬∞C)</option>
                <option value="hot">üî• Hot (> 85¬∞F / 29¬∞C)</option>
            </select>
        </div>
        <div id="topsPreview" class="preview-container"></div>
        <button id="uploadTopsBtn" style="display: none;">Upload Tops</button>
    </div>

    <!-- Bottoms Upload Section -->
    <div class="upload-section">
        <h2>Upload Bottoms</h2>
        <input type="file" id="bottomsInput" accept="image/*" multiple>
        <div style="margin: 10px 0;">
            <label>Temperature Tag:</label>
            <select id="bottomsTemperatureTag" style="padding: 8px; margin-left: 10px; font-size: 16px;">
                <option value="">-- Select (Optional) --</option>
                <option value="cold">‚ùÑÔ∏è Cold (< 50¬∞F / 10¬∞C)</option>
                <option value="cool">üçÇ Cool (50-65¬∞F / 10-18¬∞C)</option>
                <option value="mild">üå§Ô∏è Mild (65-75¬∞F / 18-24¬∞C)</option>
                <option value="warm">‚òÄÔ∏è Warm (75-85¬∞F / 24-29¬∞C)</option>
                <option value="hot">üî• Hot (> 85¬∞F / 29¬∞C)</option>
            </select>
        </div>
        <div id="bottomsPreview" class="preview-container"></div>
        <button id="uploadBottomsBtn" style="display: none;">Upload Bottoms</button>
    </div>
    
    <pre id="output"></pre>
    
    <!-- Gallery Section -->
    <div class="gallery-section">
        <h2>Currently Uploaded Tops</h2>
        <button id="refreshTops">Refresh Tops</button>
        <div id="topsGallery" class="gallery-container"></div>
    </div>
    
    <div class="gallery-section">
        <h2>Currently Uploaded Bottoms</h2>
        <button id="refreshBottoms">Refresh Bottoms</button>
        <div id="bottomsGallery" class="gallery-container"></div>
    </div>
    
    <!-- Generate Outfits Section -->
    <div class="gallery-section">
        <h2>Generate Outfits</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
            <button id="generateRandomBtn">Generate Random Outfit</button>
            <button id="generatePickedBtn">Generate Based on Picked Clothing</button>
            <button id="generateSimilarityBtn">Generate for Me (Similarity)</button>
            <button id="generateDatasetBtn">Generate for Me (Dataset)</button>
        </div>
    </div>

    <!-- Modal for displaying generated outfit -->
    <div id="outfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Your Generated Outfit</h2>
            <div class="outfit-display">
                <div class="outfit-item">
                    <h4>Top</h4>
                    <img id="outfitTopImg" alt="Top clothing item">
                    <p id="outfitTopName"></p>
                </div>
                <div class="outfit-item">
                    <h4>Bottom</h4>
                    <img id="outfitBottomImg" alt="Bottom clothing item">
                    <p id="outfitBottomName"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Wardrobe selection modal -->
    <div id="wardrobeModal" class="modal">
        <div class="wardrobe-modal-content">
            <span class="close-modal" id="closeWardrobe">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Wardrobe</h2>
            
            <div class="wardrobe-section">
                <h3>Tops</h3>
                <div id="wardrobeTopsGrid" class="wardrobe-grid"></div>
            </div>
            
            <div class="wardrobe-section">
                <h3>Bottoms</h3>
                <div id="wardrobeBottomsGrid" class="wardrobe-grid"></div>
            </div>
            
            <button id="wardrobeConfirmBtn" class="wardrobe-confirm-btn" disabled>Confirm</button>
        </div>
    </div>

    <!-- Find Outfit From Item Modal -->
    <div id="findOutfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeFindOutfit">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Find Outfit From Your Item</h2>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px;">Upload a clothing item to find a matching complete outfit:</p>
                <div style="margin-bottom: 15px;">
                    <label>Select Category:</label><br>
                    <select id="findOutfitCategory" style="padding: 8px; margin-top: 5px; width: 100%; font-size: 16px;">
                        <option value="top">Top</option>
                        <option value="bottom">Bottom</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Upload Image:</label><br>
                    <input type="file" id="findOutfitFileInput" accept="image/*" style="margin-top: 5px;">
                </div>
                <div id="findOutfitPreview" style="margin-bottom: 15px; text-align: center;"></div>

                <!-- Temperature inputs -->
                <div style="margin-bottom: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <h3 style="margin-bottom: 10px; font-size: 1.1em;">Weather Temperature (Optional)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Lowest Temp:</label><br>
                            <input type="number" id="findOutfitLowTemp" placeholder="e.g., 72" style="padding: 8px; width: 100%; margin-top: 5px;">
                        </div>
                        <div>
                            <label>Highest Temp:</label><br>
                            <input type="number" id="findOutfitHighTemp" placeholder="e.g., 80" style="padding: 8px; width: 100%; margin-top: 5px;">
                        </div>
                        <div>
                            <label>Unit:</label><br>
                            <select id="findOutfitTempUnit" style="padding: 8px; width: 100%; margin-top: 5px; font-size: 16px;">
                                <option value="fahrenheit">Fahrenheit</option>
                                <option value="celsius">Celsius</option>
                            </select>
                        </div>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Leave blank to search all clothing items</p>
                </div>

                <button id="findOutfitSearchBtn" style="width: 100%; padding: 12px; font-size: 16px;">Search for Matching Outfit</button>
            </div>
        </div>
    </div>

    <!-- Found Outfit Result Modal -->
    <div id="foundOutfitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeFoundOutfit">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Recommendation From Your Closet</h2>
            <div style="padding: 20px;">
                <p id="foundOutfitMessage" style="font-size: 1.1em; margin-bottom: 20px; text-align: center;"></p>

                <div class="outfit-display" style="display: flex; justify-content: space-around; gap: 30px; margin: 20px 0;">
                    <div class="outfit-item" style="flex: 1; text-align: center;">
                        <h4>Your Item</h4>
                        <img id="uploadedItemImg" style="max-width: 200px; height: auto; border-radius: 8px;" alt="Your clothing item">
                        <p id="uploadedItemCategory" style="margin-top: 10px; font-weight: bold;"></p>
                    </div>

                    <div style="display: flex; align-items: center; font-size: 2em; color: #666;">+</div>

                    <div class="outfit-item" style="flex: 1; text-align: center;">
                        <h4>Recommended Match</h4>
                        <img id="recommendedItemImg" style="max-width: 200px; height: auto; border-radius: 8px;" alt="Recommended item">
                        <p id="recommendedItemName" style="margin-top: 10px; font-weight: bold;"></p>
                        <p id="recommendedItemSimilarity" style="margin-top: 5px; font-size: 0.9em; color: #666;"></p>
                    </div>
                </div>

                <div id="confidenceWarning" style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px; display: none;">
                    <strong>‚ö†Ô∏è Low Confidence Match</strong>
                    <p id="confidenceMessage" style="margin: 5px 0 0 0;"></p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button id="viewReferenceOutfitBtn" style="padding: 10px 20px; font-size: 14px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        View Reference Outfit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let topsFiles = [];
        let bottomsFiles = [];
        let selectedItem = null; // {id: number, category: 'top'|'bottom'}
        
        // Handle tops file selection
        document.getElementById('topsInput').addEventListener('change', (e) => {
            topsFiles = Array.from(e.target.files);
            displayPreviews(topsFiles, 'topsPreview');
            document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
        });
        
        // Handle bottoms file selection
        document.getElementById('bottomsInput').addEventListener('change', (e) => {
            bottomsFiles = Array.from(e.target.files);
            displayPreviews(bottomsFiles, 'bottomsPreview');
            document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
        });
        
        // Display image previews
        function displayPreviews(files, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'X';
                    removeBtn.onclick = () => removePreview(index, containerId);
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    container.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Remove image from preview
        function removePreview(index, containerId) {
            if (containerId === 'topsPreview') {
                topsFiles.splice(index, 1);
                displayPreviews(topsFiles, 'topsPreview');
                document.getElementById('uploadTopsBtn').style.display = topsFiles.length > 0 ? 'block' : 'none';
            } else {
                bottomsFiles.splice(index, 1);
                displayPreviews(bottomsFiles, 'bottomsPreview');
                document.getElementById('uploadBottomsBtn').style.display = bottomsFiles.length > 0 ? 'block' : 'none';
            }
        }
        
        // Upload tops
        document.getElementById('uploadTopsBtn').addEventListener('click', async () => {
            await uploadImages(topsFiles, 'top');
            topsFiles = [];
            document.getElementById('topsPreview').innerHTML = '';
            document.getElementById('topsInput').value = '';
            document.getElementById('uploadTopsBtn').style.display = 'none';
            loadGallery('top');
        });
        
        // Upload bottoms
        document.getElementById('uploadBottomsBtn').addEventListener('click', async () => {
            await uploadImages(bottomsFiles, 'bottom');
            bottomsFiles = [];
            document.getElementById('bottomsPreview').innerHTML = '';
            document.getElementById('bottomsInput').value = '';
            document.getElementById('uploadBottomsBtn').style.display = 'none';
            loadGallery('bottom');
        });
        
        // Upload images function
        async function uploadImages(files, category) {
            const results = [];
            // Get temperature tag from the appropriate selector
            const tempTagSelector = category === 'top' ? 'topsTemperatureTag' : 'bottomsTemperatureTag';
            const temperatureTag = document.getElementById(tempTagSelector).value;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);
                if (temperatureTag) {
                    formData.append('temperature_tag', temperatureTag);
                }

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-image/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }

        // Upload outfits function
        async function uploadOutfits(files) {
            const results = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload-outfit/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    results.push(result);
                } catch (error) {
                    console.error('Outfit upload error:', error);
                }
            }
            document.getElementById('output').textContent = JSON.stringify(results, null, 2);
        }

        // Temperature tag emoji mapping
        const tempEmojiMap = {
            'cold': '‚ùÑÔ∏è Cold',
            'cool': 'üçÇ Cool',
            'mild': 'üå§Ô∏è Mild',
            'warm': '‚òÄÔ∏è Warm',
            'hot': 'üî• Hot'
        };

        // Load gallery
        async function loadGallery(category) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/get-images/${category}`);
                const images = await response.json();
                const containerId = category === 'top' ? 'topsGallery' : 'bottomsGallery';
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                for (const img of images) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';

                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-image/${category}/${img.id}`;

                    const filename = document.createElement('div');
                    filename.className = 'filename';
                    filename.textContent = img.filename;

                    // Temperature tag display
                    const tempTagDisplay = document.createElement('div');
                    tempTagDisplay.style.fontSize = '0.9em';
                    tempTagDisplay.style.color = '#666';
                    tempTagDisplay.style.marginTop = '5px';
                    tempTagDisplay.textContent = img.temperature_tag
                        ? tempEmojiMap[img.temperature_tag] || img.temperature_tag
                        : 'No temp tag';

                    // Edit temperature button
                    const editTempBtn = document.createElement('button');
                    editTempBtn.className = 'edit-temp-btn';
                    editTempBtn.textContent = 'Edit Temp';
                    editTempBtn.style.fontSize = '0.85em';
                    editTempBtn.style.padding = '4px 8px';
                    editTempBtn.style.marginTop = '5px';
                    editTempBtn.style.marginRight = '5px';
                    editTempBtn.onclick = () => editTemperatureTag(img.id, category, img.temperature_tag);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteImage(img.id, category);

                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(filename);
                    galleryItem.appendChild(tempTagDisplay);
                    const buttonContainer = document.createElement('div');
                    buttonContainer.appendChild(editTempBtn);
                    buttonContainer.appendChild(deleteBtn);
                    galleryItem.appendChild(buttonContainer);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
            }
        }

        // Load outfit gallery
        async function loadOutfitGallery() {
            try {
                const response = await fetch('http://127.0.0.1:8000/get-outfits/');
                const outfits = await response.json();
                const container = document.getElementById('outfitsGallery');
                container.innerHTML = '';

                for (const outfit of outfits) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';

                    const imgElement = document.createElement('img');
                    imgElement.src = `http://127.0.0.1:8000/get-outfit/${outfit.id}`;

                    const info = document.createElement('div');
                    info.className = 'filename';
                    info.textContent = `Outfit #${outfit.id}`;

                    galleryItem.appendChild(imgElement);
                    galleryItem.appendChild(info);
                    container.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading outfit gallery:', error);
            }
        }

        // Edit temperature tag
        async function editTemperatureTag(imageId, category, currentTag) {
            const newTag = prompt(
                `Select temperature tag for this item:\n\n` +
                `Enter one of: cold, cool, mild, warm, hot\n` +
                `Current tag: ${currentTag || 'none'}`,
                currentTag || ''
            );

            if (newTag === null) {
                return; // User cancelled
            }

            const validTags = ['cold', 'cool', 'mild', 'warm', 'hot'];
            if (newTag && !validTags.includes(newTag.toLowerCase())) {
                alert('Invalid temperature tag. Must be one of: cold, cool, mild, warm, hot');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('temperature_tag', newTag.toLowerCase());

                const response = await fetch(`http://127.0.0.1:8000/update-temperature-tag/${category}/${imageId}`, {
                    method: 'PATCH',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to update temperature tag');
                    return;
                }

                const result = await response.json();
                document.getElementById('output').textContent = JSON.stringify(result, null, 2);
                loadGallery(category);
            } catch (error) {
                console.error('Update temperature tag error:', error);
                alert('Failed to update temperature tag');
            }
        }

        // Delete image
        async function deleteImage(imageId, category) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            try {
                const response = await fetch(`http://127.0.0.1:8000/delete-image/${category}/${imageId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                document.getElementById('output').textContent = JSON.stringify(result, null, 2);
                loadGallery(category);
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Refresh buttons
        document.getElementById('refreshTops').addEventListener('click', () => loadGallery('top'));
        document.getElementById('refreshBottoms').addEventListener('click', () => loadGallery('bottom'));
        
        // Load galleries on page load
        window.addEventListener('load', () => {
            loadGallery('top');
            loadGallery('bottom');
        });
        
        // Modal functionality
        const modal = document.getElementById('outfitModal');
        const closeModal = document.getElementById('closeModal');
        const wardrobeModal = document.getElementById('wardrobeModal');
        const closeWardrobe = document.getElementById('closeWardrobe');

        // Close outfit modal when X is clicked
        closeModal.onclick = function() {
            modal.style.display = 'none';
        }

        // Close wardrobe modal when X is clicked
        closeWardrobe.onclick = function() {
            wardrobeModal.style.display = 'none';
            selectedItem = null;
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === wardrobeModal) {
                wardrobeModal.style.display = 'none';
                selectedItem = null;
            }
        }

        // Load wardrobe items into modal
        async function loadWardrobeModal() {
            try {
                // Fetch tops and bottoms
                const topsResponse = await fetch('http://127.0.0.1:8000/get-images/top');
                const bottomsResponse = await fetch('http://127.0.0.1:8000/get-images/bottom');
                
                const tops = await topsResponse.json();
                const bottoms = await bottomsResponse.json();
                
                // Populate tops grid
                const topsGrid = document.getElementById('wardrobeTopsGrid');
                topsGrid.innerHTML = '';
                tops.forEach(top => {
                    const item = createWardrobeItem(top, 'top');
                    topsGrid.appendChild(item);
                });
                
                // Populate bottoms grid
                const bottomsGrid = document.getElementById('wardrobeBottomsGrid');
                bottomsGrid.innerHTML = '';
                bottoms.forEach(bottom => {
                    const item = createWardrobeItem(bottom, 'bottom');
                    bottomsGrid.appendChild(item);
                });
                
                // Show modal
                wardrobeModal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading wardrobe:', error);
                alert('Failed to load wardrobe items');
            }
        }

        // Create wardrobe item element
        function createWardrobeItem(itemData, category) {
            const item = document.createElement('div');
            item.className = 'wardrobe-item';
            item.dataset.id = itemData.id;
            item.dataset.category = category;
            
            const img = document.createElement('img');
            img.src = `http://127.0.0.1:8000/get-image/${category}/${itemData.id}`;
            img.alt = itemData.filename;
            
            const name = document.createElement('div');
            name.className = 'item-name';
            name.textContent = itemData.filename;
            
            item.appendChild(img);
            item.appendChild(name);
            
            // Click handler for selection
            item.addEventListener('click', () => {
                // Deselect all items
                document.querySelectorAll('.wardrobe-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Select this item
                item.classList.add('selected');
                selectedItem = {
                    id: itemData.id,
                    category: category,
                    filename: itemData.filename
                };
                
                // Enable confirm button
                document.getElementById('wardrobeConfirmBtn').disabled = false;
            });
            
            return item;
        }

        // Confirm wardrobe selection and generate outfit
        document.getElementById('wardrobeConfirmBtn').addEventListener('click', async () => {
            if (!selectedItem) return;
            
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-picked-outfit/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: selectedItem.id,
                        item_category: selectedItem.category
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }
                
                const outfit = await response.json();
                
                // Close wardrobe modal
                wardrobeModal.style.display = 'none';
                
                // Display outfit in result modal
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;
                
                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;
                
                // Show outfit modal
                modal.style.display = 'block';
                
                // Reset selection
                selectedItem = null;
                document.getElementById('wardrobeConfirmBtn').disabled = true;
                
            } catch (error) {
                console.error('Error generating outfit:', error);
                alert('Failed to generate outfit');
            }
        });

        // Generate Random Outfit
        document.getElementById('generateRandomBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-random-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = outfit.bottom.filename;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating random outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        // Generate Based on Picked Clothing
        document.getElementById('generatePickedBtn').addEventListener('click', () => {
            loadWardrobeModal();
        });
        
        // Generate Similarity-Based Outfit
        document.getElementById('generateSimilarityBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/generate-similarity-outfit/');

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate outfit');
                    return;
                }

                const outfit = await response.json();

                // Set the images and filenames
                document.getElementById('outfitTopImg').src = `http://127.0.0.1:8000/get-image/top/${outfit.top.id}`;
                document.getElementById('outfitTopName').textContent = outfit.top.filename;

                document.getElementById('outfitBottomImg').src = `http://127.0.0.1:8000/get-image/bottom/${outfit.bottom.id}`;
                document.getElementById('outfitBottomName').textContent = `${outfit.bottom.filename} (Similarity: ${(outfit.similarity_score * 100).toFixed(1)}%)`;

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error generating similarity-based outfit:', error);
                alert('An error occurred while generating the outfit. Please try again.');
            }
        });
        
        document.getElementById('generateDatasetBtn').addEventListener('click', () => {
            console.log('Generate for Me (Dataset) clicked');
            // TODO: Add dataset-based outfit generation functionality
        });

        // Find Outfit From Item button
        document.getElementById('findOutfitFromItemBtn').addEventListener('click', () => {
            findOutfitModal.style.display = 'block';
        });

        // Store uploaded item data for display
        let uploadedItemData = null;

        // Handle file selection for find outfit - store preview data
        document.getElementById('findOutfitFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedItemData = event.target.result;
                    const preview = document.getElementById('findOutfitPreview');
                    preview.innerHTML = `<img src="${uploadedItemData}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Search for matching outfit
        document.getElementById('findOutfitSearchBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('findOutfitFileInput');
            const category = document.getElementById('findOutfitCategory').value;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select an image first');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', category);

            // Add temperature parameters if provided
            const lowTemp = document.getElementById('findOutfitLowTemp').value;
            const highTemp = document.getElementById('findOutfitHighTemp').value;
            const tempUnit = document.getElementById('findOutfitTempUnit').value;

            if (lowTemp || highTemp) {
                if (!lowTemp || !highTemp) {
                    alert('Please provide both lowest and highest temperatures, or leave both blank');
                    return;
                }
                formData.append('low_temp', parseFloat(lowTemp));
                formData.append('high_temp', parseFloat(highTemp));
                formData.append('temp_unit', tempUnit);
            }

            try {
                document.getElementById('findOutfitSearchBtn').textContent = 'Searching...';
                document.getElementById('findOutfitSearchBtn').disabled = true;

                const response = await fetch('http://127.0.0.1:8000/find-outfit-by-item/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Failed to find matching outfit');
                    return;
                }

                const result = await response.json();

                // Close the find outfit modal
                findOutfitModal.style.display = 'none';

                // Display the recommendation from user's closet
                document.getElementById('foundOutfitMessage').textContent = result.message;

                // Show uploaded item
                document.getElementById('uploadedItemImg').src = uploadedItemData;
                document.getElementById('uploadedItemCategory').textContent =
                    `Your ${category.charAt(0).toUpperCase() + category.slice(1)}`;

                // Show recommended item from closet
                document.getElementById('recommendedItemImg').src =
                    `http://127.0.0.1:8000/get-image/${result.recommended_item.category}/${result.recommended_item.id}`;
                document.getElementById('recommendedItemName').textContent = result.recommended_item.filename;
                document.getElementById('recommendedItemSimilarity').textContent =
                    `Match Score: ${(result.recommended_item.similarity_to_outfit * 100).toFixed(1)}%`;

                // Handle confidence warnings
                const confidenceWarning = document.getElementById('confidenceWarning');
                if (result.confidence === 'low') {
                    confidenceWarning.style.display = 'block';
                    document.getElementById('confidenceMessage').textContent = result.confidence_message;
                } else {
                    confidenceWarning.style.display = 'none';
                }

                // Store reference outfit ID for viewing
                document.getElementById('viewReferenceOutfitBtn').onclick = () => {
                    window.open(`http://127.0.0.1:8000/get-outfit/${result.outfit_reference_id}`, '_blank');
                };

                // Show the result modal
                foundOutfitModal.style.display = 'block';

                // Reset form
                fileInput.value = '';
                document.getElementById('findOutfitPreview').innerHTML = '';
                uploadedItemData = null;

            } catch (error) {
                console.error('Error finding outfit:', error);
                alert('An error occurred while searching for outfit. Please try again.');
            } finally {
                document.getElementById('findOutfitSearchBtn').textContent = 'Search for Matching Outfit';
                document.getElementById('findOutfitSearchBtn').disabled = false;
            }
        });
    </script>
</body>
</html>